<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,IE=9,chrome=1"><meta name="generator" content="MATLAB 2021a"><title>Untitled</title><style type="text/css">.rtcContent { padding: 30px; } .S0 { margin: 2px 10px 9px 4px; padding: 0px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(0, 0, 0); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: 400; text-align: left;  }
.CodeBlock { background-color: #F7F7F7; margin: 10px 0 10px 0;}
.S1 { border-left: 1px solid rgb(233, 233, 233); border-right: 1px solid rgb(233, 233, 233); border-top: 1px solid rgb(233, 233, 233); border-bottom: 0px none rgb(0, 0, 0); border-radius: 4px 4px 0px 0px; padding: 6px 45px 0px 13px; line-height: 17.234px; min-height: 18px; white-space: nowrap; color: rgb(0, 0, 0); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S2 { border-left: 1px solid rgb(233, 233, 233); border-right: 1px solid rgb(233, 233, 233); border-top: 0px none rgb(0, 0, 0); border-bottom: 0px none rgb(0, 0, 0); border-radius: 0px; padding: 0px 45px 0px 13px; line-height: 17.234px; min-height: 18px; white-space: nowrap; color: rgb(0, 0, 0); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S3 { border-left: 1px solid rgb(233, 233, 233); border-right: 1px solid rgb(233, 233, 233); border-top: 0px none rgb(0, 0, 0); border-bottom: 1px solid rgb(233, 233, 233); border-radius: 0px 0px 4px 4px; padding: 0px 45px 4px 13px; line-height: 17.234px; min-height: 18px; white-space: nowrap; color: rgb(0, 0, 0); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }</style></head><body><div class = rtcContent><div  class = 'S0'><span>Convert a MODIS image in to Teale (Albers) projection that covers the Sierra Nevada of California</span></div><div  class = 'S0'><span>This demo loads 3 bands of a full MODIS image in the sinusoidal projection, converts a subset of this image that covers the Sierra Nevada of California to the Teale projection used by the California Data Exchange Center. To reduce the size of the dataset for this illustration, the MODIS data have been coarsened to 2 km from the original 463 m.This Teale projection is an Albers Equaconic with the standard meridian at 120 W and the standard parallels at 34.5 N and 40 N. The coarsened resoluton of the original MODIS image is preserved. For display, the images are enhanced using histogram equalization. On the second pass through the loop, the output projection is rotated to align with the Sierra Nevada, so the output raster reference's TransformationType is 'affine'.</span></div><div  class = 'S0'><span>In this example, the bounding box of the area of interest extends beyond the northern boundary of the input MODIS tile, so the warning message is expected. load the MODIS image, its projection, and raster reference</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">function </span><span >modis2teale()</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >m = matfile(</span><span style="color: rgb(170, 4, 249);">'MODIS_data.mat'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >MODIS_3bands = m.MODIS_3bands;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >inputProj = MODISsinusoidal;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >RRin = m.RasterRef;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">if </span><span >~verLessThan(</span><span style="color: rgb(170, 4, 249);">'map'</span><span >,</span><span style="color: rgb(170, 4, 249);">'5.0'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    RRin.ProjectedCRS = inputProj;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(2, 128, 9);">% display the original</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >M = double(MODIS_3bands);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >M(MODIS_3bands==m.fillvalue) = NaN;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">for </span><span >k=1:size(M,3)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    X = M(:,:,k);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    t = isnan(X) | X&lt;=0;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    hX = histeq(X(~t)/nanmax(X(:)));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    newMband = zeros(size(M,1),size(M,2));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    newMband(~t) = hX;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    M(:,:,k) = newMband;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >figure</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >mapshow(M,RRin)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >title(</span><span style="color: rgb(170, 4, 249);">'original MODIS image at 2 km in sinusoidal projection'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >xlabel(</span><span style="color: rgb(170, 4, 249);">'Sinusoidal Easting, m'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >ylabel(</span><span style="color: rgb(170, 4, 249);">'Sinusoidal Northing, m'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(2, 128, 9);">%structure of the Teale projection</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >outputProj = CaliforniaAlbers;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(2, 128, 9);">%bounding box that covers the Sierra Nevada (latitudes in column 1, longitudes in column 2)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >BBox = [42.4307 -115.3796; 42.4307 -123.0667; 34.1908 -123.0667; 34.1908 -115.3796 ];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(2, 128, 9);">%output projection coordinates of the bounding box</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >[x,y] = projfwd(outputProj,BBox(:,1),BBox(:,2));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(2, 128, 9);">%in this case the bounding box extends north of the image, so we'll</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(2, 128, 9);">%restrict (to fill it in, we would need the next MODIS image to the north)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >[xw,yw] = ndgrid(RRin.XWorldLimits,RRin.YWorldLimits);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >[nlat,nlon] = projinv(inputProj,xw([1 2 4 3])',yw(:));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >[~,ny] = projfwd(outputProj,nlat,nlon);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">if </span><span >any(y(:)&gt;max(ny))</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    warning(</span><span style="color: rgb(170, 4, 249);">'(expected) input image extends beyond northern edge of bounding box, so output is truncated'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    y(y&gt;max(ny)) = max(ny);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >disp(</span><span style="color: rgb(170, 4, 249);">'input raster reference'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >disp(RRin)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(2, 128, 9);">%reproject, limiting the output to the bounding box, the output M shows the</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(2, 128, 9);">%original data (in its numerical representation) reprojected and trimmed.</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(2, 128, 9);">%On the first pass, reproject to the Teale projection.</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(2, 128, 9);">%On the second pass, reproject but rotate the projection by 26 degrees counterclockwise</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">for </span><span >pass=1:2</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(14, 0, 255);">switch </span><span >pass</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(14, 0, 255);">case </span><span >1</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            </span><span style="color: rgb(14, 0, 255);">if </span><span >verLessThan(</span><span style="color: rgb(170, 4, 249);">'map'</span><span >,</span><span style="color: rgb(170, 4, 249);">'5.0'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >                [M,RRout,fillvalue] = rasterReprojection(MODIS_3bands,RRin,</span><span style="color: rgb(170, 4, 249);">'InProj'</span><span >,inputProj,</span><span style="color: rgb(14, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >                    </span><span style="color: rgb(170, 4, 249);">'OutProj'</span><span >,outputProj,</span><span style="color: rgb(170, 4, 249);">'fillvalue'</span><span >,m.fillvalue,</span><span style="color: rgb(14, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >                    </span><span style="color: rgb(170, 4, 249);">'xlimit'</span><span >,[min(x(:)) max(x(:))],</span><span style="color: rgb(170, 4, 249);">'ylimit'</span><span >,[min(y(:)) max(y(:))]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            </span><span style="color: rgb(14, 0, 255);">else</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >                [M,RRout,fillvalue] = rasterReprojection(MODIS_3bands,RRin,</span><span style="color: rgb(14, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >                    </span><span style="color: rgb(170, 4, 249);">'OutProj'</span><span >,outputProj,</span><span style="color: rgb(170, 4, 249);">'fillvalue'</span><span >,m.fillvalue,</span><span style="color: rgb(14, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >                    </span><span style="color: rgb(170, 4, 249);">'xlimit'</span><span >,[min(x(:)) max(x(:))],</span><span style="color: rgb(170, 4, 249);">'ylimit'</span><span >,[min(y(:)) max(y(:))]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            </span><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            disp(</span><span style="color: rgb(170, 4, 249);">'output raster reference, rectilinear'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(14, 0, 255);">case </span><span >2</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            </span><span style="color: rgb(14, 0, 255);">if </span><span >verLessThan(</span><span style="color: rgb(170, 4, 249);">'map'</span><span >,</span><span style="color: rgb(170, 4, 249);">'5.0'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >                [M,RRout,fillvalue] = rasterReprojection(MODIS_3bands,RRin,</span><span style="color: rgb(170, 4, 249);">'InProj'</span><span >,inputProj,</span><span style="color: rgb(14, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >                    </span><span style="color: rgb(170, 4, 249);">'OutProj'</span><span >,outputProj,</span><span style="color: rgb(170, 4, 249);">'fillvalue'</span><span >,m.fillvalue,</span><span style="color: rgb(14, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >                    </span><span style="color: rgb(170, 4, 249);">'xlimit'</span><span >,[min(x(:)) max(x(:))],</span><span style="color: rgb(170, 4, 249);">'ylimit'</span><span >,[min(y(:)) max(y(:))],</span><span style="color: rgb(14, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >                    </span><span style="color: rgb(170, 4, 249);">'rotate'</span><span >,26);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            </span><span style="color: rgb(14, 0, 255);">else</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >                [M,RRout,fillvalue] = rasterReprojection(MODIS_3bands,RRin,</span><span style="color: rgb(14, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >                    </span><span style="color: rgb(170, 4, 249);">'OutProj'</span><span >,outputProj,</span><span style="color: rgb(170, 4, 249);">'fillvalue'</span><span >,m.fillvalue,</span><span style="color: rgb(14, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >                    </span><span style="color: rgb(170, 4, 249);">'xlimit'</span><span >,[min(x(:)) max(x(:))],</span><span style="color: rgb(170, 4, 249);">'ylimit'</span><span >,[min(y(:)) max(y(:))],</span><span style="color: rgb(14, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >                    </span><span style="color: rgb(170, 4, 249);">'rotate'</span><span >,26);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            </span><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            disp(</span><span style="color: rgb(170, 4, 249);">'output raster reference, affine'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    disp(RRout)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(2, 128, 9);">%enhance output with histogram equalization, avoiding the NaNs in the image</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(14, 0, 255);">if </span><span >~(strcmpi(class(M),</span><span style="color: rgb(170, 4, 249);">'single'</span><span >) || strcmpi(class(M),</span><span style="color: rgb(170, 4, 249);">'double'</span><span >))</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        holdM = double(M);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        holdM(M==fillvalue) = NaN;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        M = holdM;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(14, 0, 255);">else</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        M = double(M);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(14, 0, 255);">for </span><span >k=1:size(M,3)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        X = M(:,:,k);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        t = isnan(X) | X&lt;=0;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        hX = histeq(X(~t)/nanmax(X(:)));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        newMband = zeros(size(M,1),size(M,2));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        newMband(~t) = hX;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        M(:,:,k) = newMband;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    figure</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(14, 0, 255);">switch </span><span >pass</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(14, 0, 255);">case </span><span >1</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            mapshow(M,RRout);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(14, 0, 255);">case </span><span >2</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            </span><span style="color: rgb(2, 128, 9);">% can't run the same mapshow(M,RRout) where RRout has the</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            </span><span style="color: rgb(2, 128, 9);">% affine transformation (MathWorks knows about the bug)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            </span><span style="color: rgb(2, 128, 9);">% so using this workaround</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            [x,y] = pixcenters(RRout,[size(M,1) size(M,2)]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            mapshow(x,y,M);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            axis </span><span style="color: rgb(170, 4, 249);">equal tight</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    xlabel(</span><span style="color: rgb(170, 4, 249);">'Teale Easting, m'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    ylabel(</span><span style="color: rgb(170, 4, 249);">'Teale Northing, m'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(14, 0, 255);">switch </span><span >pass</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(14, 0, 255);">case </span><span >1</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            title(</span><span style="color: rgb(170, 4, 249);">'reprojected MODIS data at 2 km resolution'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(14, 0, 255);">case </span><span >2</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            title(</span><span style="color: rgb(170, 4, 249);">'reprojected MODIS data at 2 km resolution, rotated'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">end</span></span></div></div></div>
<br>
<!-- 
##### SOURCE BEGIN #####
function modis2teale()
%  MODIS2TEALE Convert a MODIS image in to Teale (Albers) projection that covers the Sierra 
% Nevada of California
% 
% This demo loads 3 bands of a full MODIS image in the sinusoidal projection, 
% converts a subset of this image that covers the Sierra Nevada of California 
% to the Teale projection used by the California Data Exchange Center. To reduce 
% the size of the dataset for this illustration, the MODIS data have been coarsened 
% to 2 km from the original 463 m.This Teale projection is an Albers Equaconic 
% with the standard meridian at 120 W and the standard parallels at 34.5 N and 
% 40 N. The coarsened resoluton of the original MODIS image is preserved. For 
% display, the images are enhanced using histogram equalization. On the second 
% pass through the loop, the output projection is rotated to align with the Sierra 
% Nevada, so the output raster reference's TransformationType is 'affine'.
% 
% In this example, the bounding box of the area of interest extends beyond the 
% northern boundary of the input MODIS tile, so the warning message is expected. 
% load the MODIS image, its projection, and raster reference
m = matfile('MODIS_data.mat');
MODIS_3bands = m.MODIS_3bands;
inputProj = MODISsinusoidal;
RRin = m.RasterRef;
if ~verLessThan('map','5.0')
    RRin.ProjectedCRS = inputProj;
end
% display the original
M = double(MODIS_3bands);
M(MODIS_3bands==m.fillvalue) = NaN;
for k=1:size(M,3)
    X = M(:,:,k);
    t = isnan(X) | X<=0;
    hX = histeq(X(~t)/nanmax(X(:)));
    newMband = zeros(size(M,1),size(M,2));
    newMband(~t) = hX;
    M(:,:,k) = newMband;
end
figure
mapshow(M,RRin)
title('original MODIS image at 2 km in sinusoidal projection')
xlabel('Sinusoidal Easting, m')
ylabel('Sinusoidal Northing, m')
%structure of the Teale projection
outputProj = CaliforniaAlbers;
%bounding box that covers the Sierra Nevada (latitudes in column 1, longitudes in column 2)
BBox = [42.4307 -115.3796; 42.4307 -123.0667; 34.1908 -123.0667; 34.1908 -115.3796 ];
%output projection coordinates of the bounding box
[x,y] = projfwd(outputProj,BBox(:,1),BBox(:,2));
%in this case the bounding box extends north of the image, so we'll
%restrict (to fill it in, we would need the next MODIS image to the north)
[xw,yw] = ndgrid(RRin.XWorldLimits,RRin.YWorldLimits);
[nlat,nlon] = projinv(inputProj,xw([1 2 4 3])',yw(:));
[~,ny] = projfwd(outputProj,nlat,nlon);
if any(y(:)>max(ny))
    warning('(expected) input image extends beyond northern edge of bounding box, so output is truncated')
    y(y>max(ny)) = max(ny);
end
disp('input raster reference')
disp(RRin)
%reproject, limiting the output to the bounding box, the output M shows the
%original data (in its numerical representation) reprojected and trimmed.
%On the first pass, reproject to the Teale projection.
%On the second pass, reproject but rotate the projection by 26 degrees counterclockwise
for pass=1:2
    switch pass
        case 1
            if verLessThan('map','5.0')
                [M,RRout,fillvalue] = rasterReprojection(MODIS_3bands,RRin,'InProj',inputProj,...
                    'OutProj',outputProj,'fillvalue',m.fillvalue,...
                    'xlimit',[min(x(:)) max(x(:))],'ylimit',[min(y(:)) max(y(:))]);
            else
                [M,RRout,fillvalue] = rasterReprojection(MODIS_3bands,RRin,...
                    'OutProj',outputProj,'fillvalue',m.fillvalue,...
                    'xlimit',[min(x(:)) max(x(:))],'ylimit',[min(y(:)) max(y(:))]);
            end
            disp('output raster reference, rectilinear')
        case 2
            if verLessThan('map','5.0')
                [M,RRout,fillvalue] = rasterReprojection(MODIS_3bands,RRin,'InProj',inputProj,...
                    'OutProj',outputProj,'fillvalue',m.fillvalue,...
                    'xlimit',[min(x(:)) max(x(:))],'ylimit',[min(y(:)) max(y(:))],...
                    'rotate',26);
            else
                [M,RRout,fillvalue] = rasterReprojection(MODIS_3bands,RRin,...
                    'OutProj',outputProj,'fillvalue',m.fillvalue,...
                    'xlimit',[min(x(:)) max(x(:))],'ylimit',[min(y(:)) max(y(:))],...
                    'rotate',26);
            end
            disp('output raster reference, affine')
    end
    disp(RRout)
    
    %enhance output with histogram equalization, avoiding the NaNs in the image
    if ~(strcmpi(class(M),'single') || strcmpi(class(M),'double'))
        holdM = double(M);
        holdM(M==fillvalue) = NaN;
        M = holdM;
    else
        M = double(M);
    end
    for k=1:size(M,3)
        X = M(:,:,k);
        t = isnan(X) | X<=0;
        hX = histeq(X(~t)/nanmax(X(:)));
        newMband = zeros(size(M,1),size(M,2));
        newMband(~t) = hX;
        M(:,:,k) = newMband;
    end
    figure
    switch pass
        case 1
            mapshow(M,RRout);
        case 2
            % can't run the same mapshow(M,RRout) where RRout has the
            % affine transformation (MathWorks knows about the bug)
            % so using this workaround
            [x,y] = pixcenters(RRout,[size(M,1) size(M,2)]);
            mapshow(x,y,M);
            axis equal tight
    end
    xlabel('Teale Easting, m')
    ylabel('Teale Northing, m')
    switch pass
        case 1
            title('reprojected MODIS data at 2 km resolution')
        case 2
            title('reprojected MODIS data at 2 km resolution, rotated')
    end
end
end
##### SOURCE END #####
-->
</div></body></html>